# Migration `20201107031131-init-data-schema`

This migration has been generated by 권수현 at 11/7/2020, 12:11:31 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
DROP INDEX `User.email_unique` ON `User`

ALTER TABLE `WeeklyAccTime` DROP FOREIGN KEY `WeeklyAccTime_ibfk_1`

ALTER TABLE `WeeklyCount` DROP FOREIGN KEY `WeeklyCount_ibfk_1`

ALTER TABLE `Mission` DROP FOREIGN KEY `Mission_ibfk_2`

ALTER TABLE `Mission` DROP FOREIGN KEY `Mission_ibfk_1`

ALTER TABLE `Mission` DROP COLUMN `createdAt`,
    DROP COLUMN `missionType`,
    DROP COLUMN `workOutId`,
    DROP COLUMN `userId`,
    ADD COLUMN `title` varchar(191)  ,
    ADD COLUMN `discription` varchar(191)  ,
    ADD COLUMN `reward` varchar(191)  ,
    ADD COLUMN `startAt` datetime(3)  ,
    ADD COLUMN `endAt` datetime(3)  ,
    ADD COLUMN `winnerId` int  

ALTER TABLE `TotalAccTime` ADD COLUMN `id` int  NOT NULL  AUTO_INCREMENT,
    MODIFY `accTime` int,
    ADD PRIMARY KEY (`id`)

ALTER TABLE `TotalCount` ADD COLUMN `id` int  NOT NULL  AUTO_INCREMENT,
    MODIFY `count` int,
    ADD PRIMARY KEY (`id`)

ALTER TABLE `User` DROP COLUMN `email`,
    ADD COLUMN `phoneNumber` varchar(191)  

ALTER TABLE `WorkOut` DROP COLUMN `workOutType`,
    ADD COLUMN `missionType` ENUM('tabata', 'static', 'setreps', 'maxreps', 'workOutTime', 'totalCount', 'totalAccTime')  ,
    MODIFY `userId` int

CREATE TABLE `Achieve` (
`id` int  NOT NULL  AUTO_INCREMENT,
`percent` int  ,
`userId` int  NOT NULL ,
`missionId` int  NOT NULL ,
UNIQUE INDEX `Achieve.userId_unique`(`userId`),
UNIQUE INDEX `Achieve.missionId_unique`(`missionId`),
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `Condition` (
`id` int  NOT NULL  AUTO_INCREMENT,
`missionType` ENUM('tabata', 'static', 'setreps', 'maxreps', 'workOutTime', 'totalCount', 'totalAccTime')  ,
`value` int  ,
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `_ConditionToMission` (
`A` int  NOT NULL ,
`B` int  NOT NULL ,
UNIQUE INDEX `_ConditionToMission_AB_unique`(`A`,
`B`),
INDEX `_ConditionToMission_B_index`(`B`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE UNIQUE INDEX `Mission.winnerId_unique` ON `Mission`(`winnerId`)

CREATE UNIQUE INDEX `User.phoneNumber_unique` ON `User`(`phoneNumber`)

ALTER TABLE `Achieve` ADD FOREIGN KEY (`userId`) REFERENCES `pushuser`.`User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `Achieve` ADD FOREIGN KEY (`missionId`) REFERENCES `pushuser`.`Mission`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `_ConditionToMission` ADD FOREIGN KEY (`A`) REFERENCES `pushuser`.`Condition`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `_ConditionToMission` ADD FOREIGN KEY (`B`) REFERENCES `pushuser`.`Mission`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `Mission` ADD FOREIGN KEY (`winnerId`) REFERENCES `pushuser`.`User`(`id`) ON DELETE SET NULL ON UPDATE CASCADE

DROP TABLE `WeeklyAccTime`

DROP TABLE `WeeklyCount`
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201017044446-user-relation..20201107031131-init-data-schema
--- datamodel.dml
+++ datamodel.dml
@@ -3,22 +3,23 @@
 }
 datasource db {
   provider = "mysql"
-  url = "***"
+  url = "***"
 }
 model Profile {
   id                Int                 @default(autoincrement()) @id
   socialId          String? 
   authType          AuthType? 
+  
   userId            Int                 @unique
   User              User                @relation(fields: [userId], references: [id])
 }   
 model User {    
   id                Int                 @default(autoincrement()) @id
-  email             String?             @unique
+  phoneNumber       String?             @unique
   password          String?       
   name              String?       
   photoURL          String?    
   birthday          DateTime?       
@@ -26,69 +27,84 @@
   createdAt         DateTime?           @default(now())
   updatedAt         DateTime?           @default(now()) @updatedAt
   deletedAt         DateTime?
   lastSignedIn      DateTime?
+
   profile           Profile?
-  workOut           WorkOut[]
-  mission           Mission[]
-  weeklyCount       WeeklyCount[]
-  totalCount        TotalCount[]
-  weeklyAccTime     WeeklyAccTime[]
-  totalAccTime      TotalAccTime[]
+  totalCount        TotalCount?
+  totalAccTime      TotalAccTime?
+
+  workOuts          WorkOut[]
+  missions          Mission[]
+  achieves          Achieve[]
 }
+model Mission {
+  id                Int                 @default(autoincrement()) @id
+  title             String?  
+  discription       String? 
+  reward            String?
+  startAt           DateTime?
+  endAt             DateTime?
+
+  winnerId          Int?                 @unique
+  User              User?                @relation(fields: [winnerId], references: [id])
+
+  achieves          Achieve[]
+  conditions        Condition[]
+}
+
 model WorkOut {
   id                Int                 @default(autoincrement()) @id
   name              String? 
-  workOutType       MissionType?
+  missionType       MissionType?
   reps              Int?
   time              Int?
   set               Int?
   rest              Int?
   createdAt         DateTime?           @default(now())
   updatedAt         DateTime?           @default(now()) @updatedAt
   deletedAt         DateTime?
-  userId            Int                 @unique
-  User              User                @relation(fields: [userId], references: [id])
-}   
-model Mission {
+  userId            Int?                 @unique
+  User              User?                @relation(fields: [userId], references: [id])
+}
+
+model Achieve {
   id                Int                 @default(autoincrement()) @id
-  createdAt         DateTime?           @default(now())
-  missionType       MissionType
-  workOutId         Int?                @unique
-  WorkOut           WorkOut?            @relation(fields: [workOutId], references: [id])
+  percent           Int?
+  
   userId            Int                 @unique
   User              User                @relation(fields: [userId], references: [id])
+  missionId         Int                 @unique
+  mission           Mission             @relation(fields: [missionId], references: [id])
 }
-model WeeklyCount {
-  userId            Int                 @unique
-  createdAt         DateTime?
-  count             Int  
-  User              User                @relation(fields: [userId], references: [id])
+model Condition {
+  id                Int                 @default(autoincrement()) @id
+  missionType       MissionType?
+  value             Int?
+
+  missions          Mission[]
 }
 model TotalCount {
-  userId            Int                 @unique
+  id                Int                 @default(autoincrement()) @id
+  count             Int?  
   createdAt         DateTime?           @default(now())
   deletedAt         DateTime?
-  count             Int  
-  User              User                @relation(fields: [userId], references: [id])
-}
-model WeeklyAccTime {
-  userId            Int                 @unique
-  createdAt         DateTime?
-  accTime           Int  
+  userId            Int                 @unique 
   User              User                @relation(fields: [userId], references: [id])
 }
 model TotalAccTime {
-  userId            Int                 @unique
+  id                Int                 @default(autoincrement()) @id
+  accTime           Int?
   createdAt         DateTime?           @default(now())
   deletedAt         DateTime?
-  accTime           Int
+
+  userId            Int                 @unique
   User              User                @relation(fields: [userId], references: [id])
 }
 enum Gender {
@@ -102,14 +118,12 @@
   apple
 }
 enum MissionType {
-  workout
-}
-
-enum WorkOutType {
   tabata
   static
   setreps
   maxreps
   workOutTime
+  totalCount
+  totalAccTime
 }
```


